<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICU Patient Monitoring System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: #10b981;
            color: white;
        }

        .connection-status.disconnected {
            background: #ef4444;
            color: white;
        }

        .dashboard {
            display: block;
        }

        .patient-detail {
            display: none;
        }

        .patients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .patient-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .patient-info h3 {
            color: #1f2937;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .patient-info p {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .patient-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-stable {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .vitals-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .vital-item {
            background: #f9fafb;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .vital-name {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .vital-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .vital-unit {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .alerts-info {
            background: #fee2e2;
            color: #991b1b;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-top: 10px;
            display: none;
        }

        .alerts-info.active {
            display: block;
        }

        .last-update {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        /* Patient Detail Page Styles */
        .detail-header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .back-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .back-button:hover {
            background: #5a67d8;
        }

        .detail-title h1 {
            color: #1f2937;
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .detail-title p {
            color: #6b7280;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title {
            color: #1f2937;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chart-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .chart-canvas {
            height: 250px;
        }

        /* Alert Panels - Split for Groq and Gemini */
        .alerts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .alerts-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .groq-panel {
            border-top: 4px solid #f59e0b;
        }

        .gemini-panel {
            border-top: 4px solid #3b82f6;
        }

        .alerts-header {
            color: #1f2937;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .alert-icon {
            margin-right: 8px;
            font-size: 1.5rem;
        }

        .groq-icon {
            color: #f59e0b;
        }

        .gemini-icon {
            color: #3b82f6;
        }

        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .alert-critical {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .alert-warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-urgent {
            background: #fecaca;
            border-color: #dc2626;
            color: #7f1d1d;
        }

        .alert-high {
            background: #fed7aa;
            border-color: #ea580c;
            color: #9a3412;
        }

        .alert-moderate {
            background: #fef3c7;
            border-color: #d97706;
            color: #92400e;
        }

        .alert-negligible {
            background: #dcfce7;
            border-color: #16a34a;
            color: #166534;
        }

        .alert-groq {
            background: #fff7ed;
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-gemini {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .alert-message {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .alert-priority {
            background: rgba(0,0,0,0.1);
            color: rgba(0,0,0,0.7);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .alert-details {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .alert-reasoning {
            font-size: 0.8rem;
            opacity: 0.7;
            font-style: italic;
        }

        .alert-doctor {
            font-size: 0.8rem;
            background: rgba(0,0,0,0.05);
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 5px;
            color: #374151;
        }

        .alert-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-left: 15px;
            white-space: nowrap;
        }

        .no-data {
            text-align: center;
            color: #9ca3af;
            padding: 40px;
        }

        @media (max-width: 768px) {
            .patients-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .alerts-section {
                grid-template-columns: 1fr;
            }
            
            .detail-header {
                flex-direction: column;
                text-align: center;
            }
            
            .back-button {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        🔴 Disconnected
    </div>

    <div class="container">
        <!-- Dashboard View -->
        <div id="dashboard" class="dashboard">
            <div class="header">
                <h1>ICU Patient Monitoring System</h1>
                <p>Real-time monitoring of 30 patients with vital signs tracking and AI-powered alerts</p>
            </div>
            
            <div id="patientsGrid" class="patients-grid">
                <!-- Patient cards will be generated here -->
            </div>
        </div>

        <!-- Patient Detail View -->
        <div id="patientDetail" class="patient-detail">
            <div class="detail-header">
                <div>
                    <button id="backButton" class="back-button">← Back to Dashboard</button>
                </div>
                <div class="detail-title">
                    <h1 id="patientTitle">Patient Details</h1>
                    <p>Real-time monitoring dashboard with AI-powered analysis</p>
                </div>
                <div id="detailConnectionStatus">
                    <!-- Connection status will be shown here -->
                </div>
            </div>

            <div id="chartsGrid" class="charts-grid">
                <!-- Charts will be generated here -->
            </div>

            <!-- Split Alerts Section -->
            <div class="alerts-section">
                <!-- Groq Alerts Panel -->
                <div class="alerts-panel groq-panel">
                    <div class="alerts-header">
                        <span class="alert-icon groq-icon">🤖</span>
                        Groq Analysis
                    </div>
                    <div id="groqAlertsList" class="alerts-list">
                        <div class="no-data">No Groq alerts</div>
                    </div>
                </div>

                <!-- Gemini Alerts Panel -->
                <div class="alerts-panel gemini-panel">
                    <div class="alerts-header">
                        <span class="alert-icon gemini-icon">💎</span>
                        Gemini Decisions
                    </div>
                    <div id="geminiAlertsList" class="alerts-list">
                        <div class="no-data">No Gemini decisions</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CASE_IDS = [609, 634, 1032, 1087, 1209, 1488, 1903, 1952, 2191, 2259, 2327, 2340, 2422, 2626, 2724, 2880, 3519, 3638, 3984, 4658, 4721, 4978, 5107, 5211, 5248, 5337, 5540, 5841, 6234, 6335];
        
        const VITAL_SIGNS = {
            HR: { name: 'Heart Rate', unit: 'bpm', color: '#ef4444', normal: [60, 100] },
            SpO2: { name: 'Oxygen Saturation', unit: '%', color: '#3b82f6', normal: [95, 100] },
            ART_SBP: { name: 'Systolic BP', unit: 'mmHg', color: '#10b981', normal: [90, 140] },
            ART_DBP: { name: 'Diastolic BP', unit: 'mmHg', color: '#8b5cf6', normal: [60, 90] },
            ART_MBP: { name: 'Mean BP', unit: 'mmHg', color: '#f59e0b', normal: [65, 105] },
            RR: { name: 'Respiratory Rate', unit: '/min', color: '#06b6d4', normal: [12, 20] },
            BT: { name: 'Body Temperature', unit: '°C', color: '#ec4899', normal: [36.1, 37.2] },
            ETCO2: { name: 'End-tidal CO2', unit: 'mmHg', color: '#84cc16', normal: [35, 45] },
            CVP: { name: 'Central Venous Pressure', unit: 'mmHg', color: '#6366f1', normal: [2, 8] },
            ECG_II: { name: 'ECG Lead II', unit: 'mV', color: '#f97316', normal: [-0.5, 0.5] }
        };

        // Global variables
        let socket;
        let patientData = {};
        let groqAlerts = {};
        let geminiAlerts = {};
        let charts = {};
        let currentPatient = null;

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io('http://localhost:5000');
            
            socket.on('connect', () => {
                console.log('Connected to server');
                updateConnectionStatus(true);
                
                // Join rooms for all patients and vital signs
                CASE_IDS.forEach(caseId => {
                    Object.keys(VITAL_SIGNS).forEach(vitalSign => {
                        const room = `patient_${caseId}_${vitalSign}`;
                        socket.emit('join', { room: room });
                    });
                    
                    // Join alert rooms
                    socket.emit('join', { room: `alert_patient_${caseId}` });
                    socket.emit('join', { room: `groq_alert_patient_${caseId}` });
                    socket.emit('join', { room: `gemini_alert_patient_${caseId}` });
                });
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
            });

            socket.on('room_data', (data) => {
                console.log('Room data received:', data);
                
                // Handle vital sign data
                if (data.signal_name && data.signal_value !== undefined) {
                    handleVitalSignData(data);
                }
                
                // Handle Groq alerts
                if (data.alert && data.caseid && !data.priority) {
                    handleGroqAlert(data);
                }
                
                // Handle Gemini alerts (decisions)
                if (data.alert && data.alert.priority && data.alert.assigned_doctor) {
                    handleGeminiAlert(data);
                }
            });

            socket.on('alert', (data) => {
                console.log('Alert received:', data);
                handleSystemAlert(data);
            });
        }

        // Handle vital sign data
        function handleVitalSignData(data) {
            const { caseid, category, signal_value, time_recorded, signal_name } = data;
            
            if (!patientData[caseid]) {
                patientData[caseid] = {
                    status: 'stable',
                    lastUpdate: Date.now(),
                    vitalSigns: {}
                };
            }

            if (!patientData[caseid].vitalSigns[category]) {
                patientData[caseid].vitalSigns[category] = [];
            }

            // Add new data point
            patientData[caseid].vitalSigns[category].push({
                value: parseFloat(signal_value),
                time_recorded: time_recorded,
                signal_name: signal_name,
                timestamp: Date.now()
            });

            // Keep only last 100 data points
            if (patientData[caseid].vitalSigns[category].length > 100) {
                patientData[caseid].vitalSigns[category] = patientData[caseid].vitalSigns[category].slice(-100);
            }

            patientData[caseid].lastUpdate = Date.now();

            // Update UI
            if (currentPatient === null) {
                updatePatientCard(caseid);
            } else if (currentPatient === caseid) {
                updateChart(category, caseid);
            }
        }

        // Handle Groq alerts
        function handleGroqAlert(data) {
            const caseid = data.caseid;
            const alert = data.alert;
            
            if (!groqAlerts[caseid]) {
                groqAlerts[caseid] = [];
            }

            const groqAlert = {
                id: Date.now(),
                type: 'groq',
                message: alert,
                caseid: caseid,
                timestamp: Date.now(),
                source: 'Groq LLM Analysis'
            };

            groqAlerts[caseid].unshift(groqAlert);
            
            // Keep only last 50 alerts
            if (groqAlerts[caseid].length > 50) {
                groqAlerts[caseid] = groqAlerts[caseid].slice(0, 50);
            }

            // Update patient status based on alert severity
            updatePatientStatus(caseid, 'warning'); // Default to warning for Groq alerts
            
            console.log(`Groq alert for patient ${caseid}:`, groqAlert);

            // Update UI
            if (currentPatient === caseid) {
                updateGroqAlertsList(caseid);
            } else {
                updatePatientCard(caseid);
            }
        }

        // Handle Gemini alerts (decisions)
        function handleGeminiAlert(data) {
            const alert = data.alert;
            const caseid = alert.case_id;
            
            if (!geminiAlerts[caseid]) {
                geminiAlerts[caseid] = [];
            }

            const geminiAlert = {
                id: Date.now(),
                type: 'gemini',
                priority: alert.priority,
                assigned_doctor: alert.assigned_doctor,
                reasoning: alert.reasoning,
                original_alert: alert.original_alert,
                agent_id: alert.agent_id,
                processing_time: alert.processing_time,
                caseid: caseid,
                timestamp: alert.timestamp * 1000 || Date.now(), // Convert to milliseconds
                source: 'Gemini AI Decision'
            };

            geminiAlerts[caseid].unshift(geminiAlert);
            
            // Keep only last 50 alerts
            if (geminiAlerts[caseid].length > 50) {
                geminiAlerts[caseid] = geminiAlerts[caseid].slice(0, 50);
            }

            // Update patient status based on priority
            updatePatientStatus(caseid, alert.priority);
            
            console.log(`Gemini decision for patient ${caseid}:`, geminiAlert);

            // Update UI
            if (currentPatient === caseid) {
                updateGeminiAlertsList(caseid);
            } else {
                updatePatientCard(caseid);
            }
        }

        // Handle system alerts (from signal processing)
        function handleSystemAlert(data) {
            const { caseid, category, signal_value, reason, time_recorded } = data;
            
            // These are handled as part of the signal processing, but we can log them
            console.log(`System alert for patient ${caseid}: ${category} - ${reason}`);
        }

        // Update patient status
        function updatePatientStatus(caseid, newStatus) {
            if (!patientData[caseid]) {
                patientData[caseid] = {
                    status: 'stable',
                    lastUpdate: Date.now(),
                    vitalSigns: {}
                };
            }

            const currentStatus = patientData[caseid].status;
            
            // Priority: critical > urgent > high > warning > moderate > stable
            const statusPriority = {
                'critical': 6,
                'urgent': 5,
                'high': 4,
                'warning': 3,
                'moderate': 2,
                'negligible': 1,
                'stable': 0
            };

            if (statusPriority[newStatus] > statusPriority[currentStatus]) {
                patientData[caseid].status = newStatus;
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = '🟢 Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = '🔴 Disconnected';
            }
        }

        // Initialize patient cards
        function initializePatientCards() {
            const grid = document.getElementById('patientsGrid');
            grid.innerHTML = '';

            CASE_IDS.forEach(caseId => {
                // Initialize patient data if not exists
                if (!patientData[caseId]) {
                    patientData[caseId] = {
                        status: 'stable',
                        lastUpdate: null,
                        vitalSigns: {}
                    };
                }

                const card = createPatientCard(caseId);
                grid.appendChild(card);
            });
        }

        // Create patient card
        function createPatientCard(caseId) {
            const card = document.createElement('div');
            card.className = 'patient-card';
            card.onclick = () => showPatientDetail(caseId);
            
            card.innerHTML = `
                <div class="patient-header">
                    <div class="patient-info">
                        <h3>Patient ${caseId}</h3>
                        <p>ICU Room ${Math.floor(Math.random() * 50) + 1}</p>
                    </div>
                    <div class="patient-status status-stable" id="status-${caseId}">
                        Stable
                    </div>
                </div>
                
                <div class="vitals-preview" id="vitals-${caseId}">
                    <div class="vital-item">
                        <div class="vital-name">Heart Rate</div>
                        <div class="vital-value">--<span class="vital-unit">bpm</span></div>
                    </div>
                    <div class="vital-item">
                        <div class="vital-name">SpO2</div>
                        <div class="vital-value">--<span class="vital-unit">%</span></div>
                    </div>
                    <div class="vital-item">
                        <div class="vital-name">Blood Pressure</div>
                        <div class="vital-value">--<span class="vital-unit">mmHg</span></div>
                    </div>
                    <div class="vital-item">
                        <div class="vital-name">Temperature</div>
                        <div class="vital-value">--<span class="vital-unit">°C</span></div>
                    </div>
                </div>
                
                <div class="alerts-info" id="alerts-${caseId}">
                    🚨 Active alerts detected
                </div>
                
                <div class="last-update" id="lastUpdate-${caseId}">
                    Last update: No data
                </div>
            `;
            
            return card;
        }

        // Update patient card
        function updatePatientCard(caseId) {
            const patient = patientData[caseId];
            if (!patient) return;

            // Update status
            const statusEl = document.getElementById(`status-${caseId}`);
            if (statusEl) {
                statusEl.className = `patient-status status-${patient.status}`;
                statusEl.textContent = patient.status.charAt(0).toUpperCase() + patient.status.slice(1);
            }

            // Update vitals preview
            const vitalsEl = document.getElementById(`vitals-${caseId}`);
            if (vitalsEl && patient.vitalSigns) {
                const vitals = vitalsEl.children;
                
                // Heart Rate
                if (patient.vitalSigns.HR && patient.vitalSigns.HR.length > 0) {
                    const latestHR = patient.vitalSigns.HR[patient.vitalSigns.HR.length - 1];
                    vitals[0].querySelector('.vital-value').innerHTML = `${latestHR.value.toFixed(0)}<span class="vital-unit">bpm</span>`;
                }
                
                // SpO2
                if (patient.vitalSigns.SpO2 && patient.vitalSigns.SpO2.length > 0) {
                    const latestSpO2 = patient.vitalSigns.SpO2[patient.vitalSigns.SpO2.length - 1];
                    vitals[1].querySelector('.vital-value').innerHTML = `${latestSpO2.value.toFixed(1)}<span class="vital-unit">%</span>`;
                }
                
                // Blood Pressure (using MBP)
                if (patient.vitalSigns.ART_MBP && patient.vitalSigns.ART_MBP.length > 0) {
                    const latestBP = patient.vitalSigns.ART_MBP[patient.vitalSigns.ART_MBP.length - 1];
                    vitals[2].querySelector('.vital-value').innerHTML = `${latestBP.value.toFixed(0)}<span class="vital-unit">mmHg</span>`;
                }
                
                // Temperature
                if (patient.vitalSigns.BT && patient.vitalSigns.BT.length > 0) {
                    const latestBT = patient.vitalSigns.BT[patient.vitalSigns.BT.length - 1];
                    vitals[3].querySelector('.vital-value').innerHTML = `${latestBT.value.toFixed(1)}<span class="vital-unit">°C</span>`;
                }
            }

            // Update alerts info
            const alertsEl = document.getElementById(`alerts-${caseId}`);
            const groqCount = groqAlerts[caseId] ? groqAlerts[caseId].length : 0;
            const geminiCount = geminiAlerts[caseId] ? geminiAlerts[caseId].length : 0;
            const totalAlerts = groqCount + geminiCount;
            
            if (alertsEl) {
                if (totalAlerts > 0) {
                    alertsEl.className = 'alerts-info active';
                    alertsEl.textContent = `🚨 ${totalAlerts} active alert${totalAlerts > 1 ? 's' : ''} (${groqCount} Groq, ${geminiCount} Gemini)`;
                } else {
                    alertsEl.className = 'alerts-info';
                }
            }

            // Update last update time
            const lastUpdateEl = document.getElementById(`lastUpdate-${caseId}`);
            if (lastUpdateEl && patient.lastUpdate) {
                const timeDiff = Date.now() - patient.lastUpdate;
                let timeText;
                if (timeDiff < 60000) {
                    timeText = 'Just now';
                } else if (timeDiff < 3600000) {
                    timeText = `${Math.floor(timeDiff / 60000)}m ago`;
                } else {
                    timeText = `${Math.floor(timeDiff / 3600000)}h ago`;
                }
                lastUpdateEl.textContent = `Last update: ${timeText}`;
            }
        }

        // Show patient detail page
        function showPatientDetail(caseId) {
            currentPatient = caseId;
            
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('patientDetail').style.display = 'block';
            document.getElementById('patientTitle').textContent = `Patient ${caseId}`;
            
            createCharts(caseId);
            updateGroqAlertsList(caseId);
            updateGeminiAlertsList(caseId);
        }

        // Create charts for patient detail
        function createCharts(caseId) {
            const chartsGrid = document.getElementById('chartsGrid');
            chartsGrid.innerHTML = '';
            charts = {};

            const patient = patientData[caseId];
            if (!patient || !patient.vitalSigns) return;

            Object.keys(VITAL_SIGNS).forEach(vitalSign => {
                if (patient.vitalSigns[vitalSign] && patient.vitalSigns[vitalSign].length > 0) {
                    const chartContainer = createChartContainer(vitalSign, caseId);
                    chartsGrid.appendChild(chartContainer);
                    initializeChart(vitalSign, caseId);
                }
            });
        }

        // Create chart container
        function createChartContainer(vitalSign, caseId) {
            const container = document.createElement('div');
            container.className = 'chart-container';
            
            const config = VITAL_SIGNS[vitalSign];
            const patient = patientData[caseId];
            const data = patient.vitalSigns[vitalSign];
            const latestValue = data && data.length > 0 ? data[data.length - 1].value : 0;
            
            container.innerHTML = `
                <div class="chart-header">
                    <div>
                        <div class="chart-title">${config.name}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">${vitalSign}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="chart-value" style="color: ${config.color};">
                            ${latestValue.toFixed(1)} <span style="font-size: 0.875rem; color: #6b7280;">${config.unit}</span>
                        </div>
                        ${config.normal ? `<div style="font-size: 0.75rem; color: #9ca3af;">Normal: ${config.normal[0]}-${config.normal[1]} ${config.unit}</div>` : ''}
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="chart-${vitalSign}-${caseId}"></canvas>
                </div>
            `;
            
            return container;
        }

        // Initialize chart
        function initializeChart(vitalSign, caseId) {
            const ctx = document.getElementById(`chart-${vitalSign}-${caseId}`).getContext('2d');
            const config = VITAL_SIGNS[vitalSign];
            const patient = patientData[caseId];
            const data = patient.vitalSigns[vitalSign] || [];

            const chartData = data.slice(-50).map((item, index) => ({
                x: new Date(item.time_recorded || item.timestamp).toLocaleTimeString(),
                y: item.value
            }));

            charts[vitalSign] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: config.name,
                        data: chartData,
                        borderColor: config.color,
                        backgroundColor: config.color + '20',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                    },
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `${config.name} (${config.unit})`
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${config.name}: ${context.parsed.y} ${config.unit}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update chart
        function updateChart(vitalSign, caseId) {
            if (!charts[vitalSign]) return;

            const patient = patientData[caseId];
            const data = patient.vitalSigns[vitalSign] || [];
            
            const chartData = data.slice(-50).map((item, index) => ({
                x: new Date(item.time_recorded || item.timestamp).toLocaleTimeString(),
                y: item.value
            }));

            charts[vitalSign].data.datasets[0].data = chartData;
            charts[vitalSign].update('none');

            // Update chart header value
            const config = VITAL_SIGNS[vitalSign];
            const latestValue = data.length > 0 ? data[data.length - 1].value : 0;
            const chartValue = document.querySelector(`#chart-${vitalSign}-${caseId}`).closest('.chart-container').querySelector('.chart-value');
            if (chartValue) {
                chartValue.innerHTML = `${latestValue.toFixed(1)} <span style="font-size: 0.875rem; color: #6b7280;">${config.unit}</span>`;
            }
        }

        // Update Groq alerts list
        function updateGroqAlertsList(caseId) {
            const alertsList = document.getElementById('groqAlertsList');
            const alerts = groqAlerts[caseId] || [];

            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="no-data">No Groq alerts</div>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-groq">
                    <div class="alert-content">
                        <div class="alert-message">
                            <div class="alert-title">
                                Groq LLM Analysis
                            </div>
                            <div class="alert-details">
                                ${alert.message}
                            </div>
                        </div>
                        <div class="alert-time">
                            ${new Date(alert.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update Gemini alerts list
        function updateGeminiAlertsList(caseId) {
            const alertsList = document.getElementById('geminiAlertsList');
            const alerts = geminiAlerts[caseId] || [];

            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="no-data">No Gemini decisions</div>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.priority}">
                    <div class="alert-content">
                        <div class="alert-message">
                            <div class="alert-title">
                                Medical Decision
                                <span class="alert-priority">${alert.priority}</span>
                            </div>
                            <div class="alert-details">
                                <strong>Original Alert:</strong> ${alert.original_alert || 'N/A'}
                            </div>
                            <div class="alert-reasoning">
                                <strong>Reasoning:</strong> ${alert.reasoning || 'N/A'}
                            </div>
                            <div class="alert-doctor">
                                <strong>Assigned Doctor:</strong> ${alert.assigned_doctor || 'N/A'}
                            </div>
                            ${alert.processing_time ? `<div style="font-size: 0.7rem; color: #9ca3af; margin-top: 5px;">Processing time: ${alert.processing_time.toFixed(2)}s | Agent: ${alert.agent_id}</div>` : ''}
                        </div>
                        <div class="alert-time">
                            ${new Date(alert.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Go back to dashboard
        function goBackToDashboard() {
            currentPatient = null;
            
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            document.getElementById('patientDetail').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Refresh all patient cards
            CASE_IDS.forEach(caseId => updatePatientCard(caseId));
        }

        // Simulate test data (for development/testing)
        function simulateTestData() {
            const testCaseId = CASE_IDS[0];
            const testVitalSigns = ['HR', 'SpO2', 'ART_MBP', 'BT'];
            
            testVitalSigns.forEach(vitalSign => {
                const config = VITAL_SIGNS[vitalSign];
                let baseValue;
                
                switch(vitalSign) {
                    case 'HR': baseValue = 75; break;
                    case 'SpO2': baseValue = 98; break;
                    case 'ART_MBP': baseValue = 85; break;
                    case 'BT': baseValue = 36.8; break;
                    default: baseValue = 50;
                }
                
                const testData = {
                    caseid: testCaseId,
                    category: vitalSign,
                    signal_value: baseValue + (Math.random() - 0.5) * 10,
                    time_recorded: new Date().toISOString(),
                    signal_name: `Test_${vitalSign}`
                };
                
                handleVitalSignData(testData);
            });
        }

        // Simulate test alerts
        function simulateTestAlerts() {
            const testCaseId = CASE_IDS[0];
            
            // Simulate Groq alert
            handleGroqAlert({
                caseid: testCaseId,
                alert: "MEDICAL ANALYSIS: Patient shows concerning heart rate variability with potential arrhythmia detected. Recommend immediate cardiac monitoring and evaluation."
            });
            
            // Simulate Gemini alert
            handleGeminiAlert({
                alert: {
                    case_id: testCaseId,
                    priority: "high",
                    assigned_doctor: "dr_smith_cardiology",
                    reasoning: "Patient exhibits abnormal cardiac patterns requiring cardiologist evaluation",
                    original_alert: "Heart rate anomaly detected",
                    agent_id: "GeminiAgent_1",
                    processing_time: 1.24,
                    timestamp: Date.now() / 1000
                }
            });
        }

        // Initialize the application
        function initializeApp() {
            console.log('Initializing ICU Monitoring System...');
            
            // Initialize patient cards
            initializePatientCards();
            
            // Set up back button
            document.getElementById('backButton').onclick = goBackToDashboard;
            
            // Initialize socket connection
            initializeSocket();
            
            // For testing - uncomment the lines below to generate test data
            // setInterval(simulateTestData, 5000);
            // setTimeout(simulateTestAlerts, 3000);
            
            console.log('ICU Monitoring System initialized successfully!');
        }

        // Update patient cards periodically
        function startPeriodicUpdates() {
            setInterval(() => {
                if (currentPatient === null) {
                    CASE_IDS.forEach(caseId => {
                        updatePatientCard(caseId);
                    });
                }
            }, 30000); // Update every 30 seconds
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && socket) {
                // Reconnect if needed when page becomes visible
                if (!socket.connected) {
                    socket.connect();
                }
            }
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            startPeriodicUpdates();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && currentPatient !== null) {
                    goBackToDashboard();
                }
            });
        });

        // Handle window beforeunload
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });

        // Export functions for debugging (available in browser console)
        window.ICUMonitoring = {
            patientData,
            groqAlerts,
            geminiAlerts,
            simulateTestData,
            simulateTestAlerts,
            socket: () => socket,
            goToPatient: showPatientDetail,
            goBack: goBackToDashboard
        };
    </script>
</body>
</html>